<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>02 - Amazon Connect Integration | Cresta AI Platform Technical Assessment</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
            --accent-blue: #3b82f6; --accent-cyan: #22d3ee; --accent-green: #22c55e;
            --accent-yellow: #eab308; --accent-orange: #f97316; --accent-red: #ef4444;
            --accent-purple: #a855f7; --border-color: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.7; font-size: 15px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 60px; }
        header { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-bottom: 1px solid var(--border-color); padding: 48px 0; }
        header .container { display: flex; justify-content: space-between; align-items: flex-start; }
        .header-content h1 { font-size: 2.25rem; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-orange) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-content .subtitle { font-size: 1.125rem; color: var(--text-secondary); }
        .doc-badge { font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-yellow) 100%); padding: 8px 16px; border-radius: 8px; font-size: 0.875rem; font-weight: 600; }
        nav.doc-nav { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 12px 0; position: sticky; top: 0; z-index: 100; }
        nav.doc-nav ul { list-style: none; display: flex; gap: 6px; max-width: 1400px; margin: 0 auto; padding: 0 60px; overflow-x: auto; }
        nav.doc-nav a { color: var(--text-secondary); text-decoration: none; padding: 10px 16px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; white-space: nowrap; transition: all 0.2s; }
        nav.doc-nav a:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        nav.doc-nav a.active { background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-yellow) 100%); color: white; }
        section { margin-bottom: 48px; }
        h2 { font-size: 1.5rem; font-weight: 700; margin: 48px 0 24px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; gap: 12px; }
        h2::before { content: ''; display: inline-block; width: 4px; height: 24px; background: linear-gradient(180deg, var(--accent-orange) 0%, var(--accent-yellow) 100%); border-radius: 2px; }
        h3 { font-size: 1.125rem; font-weight: 600; margin: 32px 0 16px; color: var(--accent-cyan); }
        p { margin-bottom: 16px; color: var(--text-secondary); }
        .legend { display: flex; flex-wrap: wrap; gap: 12px; padding: 20px 24px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 32px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; padding: 6px 12px; background: var(--bg-tertiary); border-radius: 6px; }
        .context-box { background: linear-gradient(135deg, rgba(249, 115, 22, 0.08) 0%, rgba(234, 179, 8, 0.08) 100%); border: 1px solid var(--border-color); border-left: 4px solid var(--accent-orange); border-radius: 0 12px 12px 0; padding: 24px; margin: 24px 0; }
        .context-box strong { color: var(--accent-orange); }
        .diagram-container { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 32px; margin: 24px 0; overflow-x: auto; }
        .diagram-title { font-size: 1rem; font-weight: 600; margin-bottom: 24px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .diagram-title::before { content: ''; display: inline-block; width: 4px; height: 20px; background: var(--accent-orange); border-radius: 2px; }
        table { width: 100%; border-collapse: collapse; margin: 24px 0; font-size: 0.925rem; background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
        th, td { padding: 14px 18px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(249, 115, 22, 0.05); }
        .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .badge.confirmed { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .badge.pending { background: rgba(234, 179, 8, 0.15); color: var(--accent-yellow); }
        .badge.high { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .badge.medium { background: rgba(249, 115, 22, 0.15); color: var(--accent-orange); }
        .badge.low { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .badge.required { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .badge.custom { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin: 24px 0; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; }
        .card h4 { font-size: 1rem; font-weight: 600; margin-bottom: 16px; }
        .card.latency { border-left: 4px solid var(--accent-yellow); }
        .card.security { border-left: 4px solid var(--accent-green); }
        .card.compliance { border-left: 4px solid var(--accent-blue); }
        .card.operational { border-left: 4px solid var(--accent-purple); }
        .highlight-box { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; margin: 24px 0; }
        .highlight-box.warning { border-left: 4px solid var(--accent-yellow); }
        .highlight-box.info { border-left: 4px solid var(--accent-blue); }
        .highlight-box.danger { border-left: 4px solid var(--accent-red); }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        code { font-family: 'JetBrains Mono', monospace; background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 0.875rem; color: var(--accent-cyan); }
        footer { background: var(--bg-secondary); border-top: 1px solid var(--border-color); padding: 32px 0; margin-top: 64px; }
        footer .container { display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-muted); }
        @media (max-width: 1024px) { .container { padding: 24px; } nav.doc-nav ul { padding: 0 24px; } .two-col { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>Amazon Connect Integration</h1>
                <p class="subtitle">KVS Streaming, Contact Flow Configuration, and Lambda Integration</p>
            </div>
            <span class="doc-badge">Document 02</span>
        </div>
    </header>

    <nav class="doc-nav">
        <ul>
            <li><a href="00-executive-summary.html">00 Summary</a></li>
            <li><a href="01-overall-architecture.html">01 Architecture</a></li>
            <li><a href="#" class="active">02 Connect</a></li>
            <li><a href="03-voice-stack-architecture.html">03 Voice Stack</a></li>
            <li><a href="04-ml-services-architecture.html">04 ML Services</a></li>
            <li><a href="05-realtime-dataflow-sequences.html">05 Data Flow</a></li>
            <li><a href="06-data-security-architecture.html">06 Security</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="legend">
            <div class="legend-item">‚è±Ô∏è Latency Risk</div>
            <div class="legend-item">üîí Security Risk</div>
            <div class="legend-item">üìã Compliance Risk</div>
            <div class="legend-item">‚öôÔ∏è Operational Risk</div>
            <div class="legend-item">üü° Requires Follow-up</div>
            <div class="legend-item">‚úÖ Confirmed</div>
        </div>

        <section>
            <h2>Integration Architecture Overview</h2>
            
            <div class="context-box">
                <strong>Context:</strong> When a call arrives, the Contact Flow initiates media streaming to Kinesis Video Streams (KVS), then invokes a Lambda function to notify Cresta with stream metadata (streamARN, ContactId, startFragmentNum). Cresta consumes the audio stream and provides real-time guidance back to the agent through the Cresta Agent App, which integrates with the CCP workspace.
            </div>

            <div class="diagram-container">
                <div class="diagram-title">Amazon Connect to Cresta Integration Flow</div>
                <div class="mermaid">
flowchart TB
    subgraph AmazonConnect["Amazon Connect Instance"]
        subgraph ContactFlow["Contact Flow Configuration"]
            StartMedia["Start Media<br/>Streaming Block"]
            SetAttributes["Set Contact<br/>Attributes"]
            InvokeLambda["Invoke AWS<br/>Lambda"]
            TransferAgent["Transfer to<br/>Agent Queue"]
            StopMedia["Stop Media<br/>Streaming Block"]
        end

        subgraph MediaStreaming["Media Streaming"]
            KVS["Kinesis Video<br/>Streams"]
            KVSProducer["KVS Producer"]
            AudioTracks["Multi-Track Audio<br/>‚Ä¢ AUDIO_TO_CUSTOMER<br/>‚Ä¢ AUDIO_FROM_CUSTOMER"]
        end

        subgraph AgentSide["Agent Desktop"]
            CCP["Contact Control<br/>Panel"]
            AgentAudio["Agent Audio"]
        end
    end

    subgraph AWSServices["AWS Services (Customer Account)"]
        Lambda["AWS Lambda<br/>Trigger Function"]
        IAMRole["IAM Role"]
    end

    subgraph CrestaIngestion["Cresta Audio Ingestion"]
        CrestaEndpoint["Cresta WebSocket<br/>Endpoint"]
        AgentApp["Cresta Agent App"]
        GoWalter["gowalter"]
    end

    StartMedia --> SetAttributes --> InvokeLambda --> TransferAgent --> StopMedia
    StartMedia --> KVSProducer --> KVS --> AudioTracks
    InvokeLambda --> Lambda --> IAMRole
    IAMRole --> KVS
    AudioTracks -->|"WebSocket/HTTP2"| CrestaEndpoint --> GoWalter
    CCP --> AgentApp --> GoWalter
                </div>
            </div>
        </section>

        <section>
            <h2>Complete Integration Component Reference</h2>
            
            <h3>Amazon Connect Components</h3>
            <table>
                <thead><tr><th>Component</th><th>Type</th><th>Function</th><th>Owner</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td><strong>Contact Flow</strong></td><td>Amazon Connect</td><td>IVR logic, call routing, media streaming initiation</td><td>Customer</td><td><span class="badge confirmed">‚úì AWS Docs</span></td></tr>
                    <tr><td><strong>Start Media Streaming</strong></td><td>Flow Block</td><td>Initiates KVS streaming for call audio</td><td>Customer</td><td><span class="badge confirmed">‚úì AWS Docs</span></td></tr>
                    <tr><td><strong>Set Contact Attributes</strong></td><td>Flow Block</td><td>Stores metadata for downstream processing</td><td>Customer</td><td><span class="badge confirmed">‚úì AWS Docs</span></td></tr>
                    <tr><td><strong>Invoke Lambda</strong></td><td>Flow Block</td><td>Triggers external processing functions</td><td>Customer</td><td><span class="badge confirmed">‚úì AWS Docs</span></td></tr>
                    <tr><td><strong>Kinesis Video Streams</strong></td><td>AWS Service</td><td>Real-time audio transport (8kHz PCM, dual-track)</td><td>AWS</td><td><span class="badge confirmed">‚úì AWS Docs</span></td></tr>
                    <tr><td><strong>Contact Control Panel</strong></td><td>Agent UI</td><td>Agent workspace for call control</td><td>AWS</td><td><span class="badge confirmed">‚úì AWS</span></td></tr>
                    <tr><td><strong>Contact Trace Records</strong></td><td>Analytics Data</td><td>Call metadata and outcomes</td><td>AWS</td><td><span class="badge confirmed">‚úì AWS Docs</span></td></tr>
                </tbody>
            </table>

            <h3>AWS Lambda Integration</h3>
            <table>
                <thead><tr><th>Component</th><th>Technology</th><th>Function</th><th>Owner</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td><strong>Lambda Function</strong></td><td>AWS Lambda</td><td>Notifies Cresta with stream metadata</td><td>Customer/Cresta</td><td><span class="badge pending">üü° Verify provider</span></td></tr>
                    <tr><td><strong>KVS Consumer Logic</strong></td><td>Lambda + Parser Lib</td><td>Consumes audio from KVS stream</td><td>üü° TBD</td><td><span class="badge pending">üü° Verify method</span></td></tr>
                    <tr><td><strong>IAM Execution Role</strong></td><td>AWS IAM</td><td>Cross-account KVS access permissions</td><td>Customer</td><td><span class="badge pending">üü° Verify config</span></td></tr>
                    <tr><td><strong>Environment Variables</strong></td><td>Lambda Config</td><td>Cresta endpoint URL, credentials</td><td>Customer</td><td><span class="badge pending">üü° Verify</span></td></tr>
                    <tr><td><strong>VPC Configuration</strong></td><td>AWS VPC</td><td>Network routing (if required)</td><td>Customer</td><td><span class="badge pending">üü° Verify</span></td></tr>
                </tbody>
            </table>

            <h3>Cresta Platform Components</h3>
            <table>
                <thead><tr><th>Component</th><th>Technology</th><th>Function</th><th>Owner</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td><strong>Cresta WebSocket Endpoint</strong></td><td>WebSocket API</td><td>Receives audio stream from KVS or Lambda</td><td>Cresta</td><td><span class="badge pending">üü° Verify auth</span></td></tr>
                    <tr><td><strong>gowalter Service</strong></td><td>Cresta Service</td><td>Audio handling, buffering, ASR coordination</td><td>Cresta</td><td><span class="badge confirmed">‚úì Cresta Blog</span></td></tr>
                    <tr><td><strong>Cresta Agent App</strong></td><td>Desktop Application</td><td>Real-time guidance display, optional audio capture</td><td>Cresta</td><td><span class="badge pending">üü° Verify deployment</span></td></tr>
                    <tr><td><strong>clientsubscription</strong></td><td>Cresta Service</td><td>WebSocket event delivery to Agent App</td><td>Cresta</td><td><span class="badge confirmed">‚úì Cresta Blog</span></td></tr>
                    <tr><td><strong>apiserver</strong></td><td>Cresta Service</td><td>Transcript persistence, ML trigger</td><td>Cresta</td><td><span class="badge confirmed">‚úì Cresta Blog</span></td></tr>
                </tbody>
            </table>

            <h3>Kinesis Video Streams Configuration</h3>
            <table>
                <thead><tr><th>Parameter</th><th>Value</th><th>Description</th><th>POC Consideration</th></tr></thead>
                <tbody>
                    <tr><td><strong>Sample Rate</strong></td><td>8 kHz</td><td>Standard telephony rate</td><td>ASR optimized for 8kHz</td></tr>
                    <tr><td><strong>Encoding</strong></td><td>PCM (16-bit)</td><td>Uncompressed audio</td><td>No transcoding needed</td></tr>
                    <tr><td><strong>Channels</strong></td><td>Mono (per track)</td><td>Separate mono tracks</td><td>Enables speaker diarization</td></tr>
                    <tr><td><strong>AUDIO_TO_CUSTOMER</strong></td><td>Track 1</td><td>Agent speech + prompts</td><td>Agent utterances</td></tr>
                    <tr><td><strong>AUDIO_FROM_CUSTOMER</strong></td><td>Track 2</td><td>Customer speech</td><td>Customer utterances</td></tr>
                    <tr><td><strong>Fragment Duration</strong></td><td>2 seconds</td><td>KVS chunk size</td><td>Latency consideration</td></tr>
                    <tr><td><strong>Retention Period</strong></td><td>Customer-defined</td><td>Audio retention in KVS</td><td>Configure for compliance</td></tr>
                    <tr><td><strong>Encryption</strong></td><td>TLS in-transit</td><td>Encrypted streaming</td><td>Security requirement</td></tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Integration Methods</h2>
            
            <div class="two-col">
                <div class="highlight-box info">
                    <h3>Option A: Direct CCaaS Stream (Preferred)</h3>
                    <p>Amazon Connect streams audio directly to Cresta via Kinesis Video Streams.</p>
                    <table>
                        <tr><td><strong>Step 1</strong></td><td>Contact Flow triggers "Start Media Streaming" block</td></tr>
                        <tr><td><strong>Step 2</strong></td><td>Audio captured at 8kHz PCM, dual-track</td></tr>
                        <tr><td><strong>Step 3</strong></td><td>Lambda passes streamARN and ContactId to Cresta</td></tr>
                        <tr><td><strong>Step 4</strong></td><td>Cresta consumes stream via WebSocket/GetMedia API</td></tr>
                    </table>
                    <p style="margin-top: 16px;"><strong>Advantages:</strong> Lower latency, server-side processing, no desktop dependency, more reliable</p>
                </div>
                
                <div class="highlight-box warning">
                    <h3>Option B: Agent App Capture (Fallback) üü°</h3>
                    <p>For CCaaS platforms that don't provide audio streams, Cresta Agent App captures from desktop.</p>
                    <table>
                        <tr><td><strong>Step 1</strong></td><td>Agent App installed on agent desktop</td></tr>
                        <tr><td><strong>Step 2</strong></td><td>Captures system audio (mic + speakers)</td></tr>
                        <tr><td><strong>Step 3</strong></td><td>gowalter receives audio via direct upload</td></tr>
                    </table>
                    <p style="margin-top: 16px;"><strong>‚ö†Ô∏è Requires Verification:</strong> Confirm which method Amazon Connect integration uses. Option A is strongly preferred for production deployment.</p>
                </div>
            </div>
        </section>

        <section>
            <h2>Contact Flow Configuration</h2>
            
            <div class="diagram-container">
                <div class="diagram-title">Recommended Contact Flow Structure</div>
                <div class="mermaid">
flowchart LR
    Entry["Entry Point"] --> SetLang["Set Voice<br/>(Language)"]
    SetLang --> StartStream["Start Media<br/>Streaming ‚è±Ô∏è"]
    StartStream --> SetCresta["Set Contact<br/>Attributes<br/>(Cresta Config)"]
    SetCresta --> TriggerLambda["Invoke Lambda<br/>(kvsConsumerTrigger)"]
    TriggerLambda --> PlayPrompt["Play Prompt"]
    PlayPrompt --> Queue["Transfer to<br/>Queue"]
    Queue --> AgentConnect["Agent<br/>Connected"]
    AgentConnect --> EndContact["End Contact"]
    EndContact --> StopStream["Stop Media<br/>Streaming"]
                </div>
            </div>

            <h3>Contact Flow Block Details</h3>
            <table>
                <thead><tr><th>Block</th><th>Purpose</th><th>Configuration</th><th>Notes</th></tr></thead>
                <tbody>
                    <tr><td><strong>Entry Point</strong></td><td>Call initiation</td><td>Phone number assignment</td><td>Standard Connect block</td></tr>
                    <tr><td><strong>Set Voice</strong></td><td>Language selection</td><td>Based on caller input or default</td><td>Affects ASR language model</td></tr>
                    <tr><td><strong>Start Media Streaming</strong></td><td>Initiate KVS</td><td>Enable "From Customer" and "To Customer"</td><td>‚è±Ô∏è Critical for real-time</td></tr>
                    <tr><td><strong>Set Contact Attributes</strong></td><td>Cresta metadata</td><td>Set CrestaCustomerId, CrestaProfileId</td><td>üü° Verify required attributes</td></tr>
                    <tr><td><strong>Invoke Lambda</strong></td><td>Notify Cresta</td><td>Function ARN, timeout 30s</td><td>Passes stream metadata</td></tr>
                    <tr><td><strong>Play Prompt</strong></td><td>Customer message</td><td>Optional hold music/message</td><td>While routing to agent</td></tr>
                    <tr><td><strong>Transfer to Queue</strong></td><td>Route to agent</td><td>Queue selection logic</td><td>Standard Connect routing</td></tr>
                    <tr><td><strong>Agent Connected</strong></td><td>Call handling</td><td>‚Äî</td><td>Cresta provides guidance</td></tr>
                    <tr><td><strong>End Contact</strong></td><td>Call termination</td><td>‚Äî</td><td>Triggers cleanup</td></tr>
                    <tr><td><strong>Stop Media Streaming</strong></td><td>Close KVS</td><td>‚Äî</td><td>Required for proper cleanup</td></tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Required Contact Attributes</h2>
            
            <h3>System-Provided Attributes (Amazon Connect)</h3>
            <table>
                <thead><tr><th>Attribute</th><th>Source</th><th>Type</th><th>Purpose</th><th>Example</th></tr></thead>
                <tbody>
                    <tr><td><code>streamARN</code></td><td>Connect System</td><td><span class="badge required">System</span></td><td>KVS stream identifier</td><td><code>arn:aws:kinesisvideo:us-west-2:123456789012:stream/...</code></td></tr>
                    <tr><td><code>startFragmentNum</code></td><td>Connect System</td><td><span class="badge required">System</span></td><td>Starting point in stream</td><td><code>91343852333181432392...</code></td></tr>
                    <tr><td><code>ContactId</code></td><td>Connect System</td><td><span class="badge required">System</span></td><td>Unique call identifier</td><td><code>abc123-def456-ghi789</code></td></tr>
                    <tr><td><code>CustomerPhoneNumber</code></td><td>Connect System</td><td><span class="badge required">System</span></td><td>Caller ANI</td><td><code>+14155551234</code></td></tr>
                    <tr><td><code>SystemPhoneNumber</code></td><td>Connect System</td><td><span class="badge required">System</span></td><td>Called number (DNIS)</td><td><code>+18005551234</code></td></tr>
                    <tr><td><code>InstanceId</code></td><td>Connect System</td><td><span class="badge required">System</span></td><td>Connect instance identifier</td><td><code>aaaaaaaa-bbbb-cccc-dddd-...</code></td></tr>
                    <tr><td><code>InitiationMethod</code></td><td>Connect System</td><td><span class="badge required">System</span></td><td>INBOUND, OUTBOUND, TRANSFER, etc.</td><td><code>INBOUND</code></td></tr>
                </tbody>
            </table>

            <h3>Custom Attributes (Customer-Defined) üü°</h3>
            <table>
                <thead><tr><th>Attribute</th><th>Purpose</th><th>Example</th><th>Required?</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td><code>CrestaCustomerId</code></td><td>Cresta tenant identifier</td><td><code>acme-corp</code></td><td>üü° TBD</td><td><span class="badge pending">üü° Verify</span></td></tr>
                    <tr><td><code>CrestaProfileId</code></td><td>Team/profile mapping</td><td><code>sales-team-a</code></td><td>üü° TBD</td><td><span class="badge pending">üü° Verify</span></td></tr>
                    <tr><td><code>CrestaAgentId</code></td><td>Agent identifier</td><td><code>agent-12345</code></td><td>üü° TBD</td><td><span class="badge pending">üü° Verify</span></td></tr>
                    <tr><td><code>CrestaSkillset</code></td><td>Agent skillset for routing</td><td><code>technical-support</code></td><td>Optional</td><td><span class="badge pending">üü° Verify</span></td></tr>
                    <tr><td><code>CrestaLanguage</code></td><td>Override ASR language</td><td><code>en-US</code></td><td>Optional</td><td><span class="badge pending">üü° Verify</span></td></tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Lambda Integration Architecture</h2>
            
            <div class="diagram-container">
                <div class="diagram-title">Lambda Consumer Flow</div>
                <div class="mermaid">
sequenceDiagram
    participant CF as Contact Flow
    participant Lambda as AWS Lambda
    participant KVS as Kinesis Video Streams
    participant Cresta as Cresta Endpoint
    participant IAM as IAM Role

    Note over CF,IAM: Call Initiated

    CF->>CF: Start Media Streaming
    CF->>Lambda: Invoke with Contact Attributes
    activate Lambda
    
    Lambda->>Lambda: Extract streamARN, ContactId, startFragmentNum
    Lambda->>IAM: Assume Role
    IAM-->>Lambda: Temporary Credentials
    
    Lambda->>Cresta: POST /stream/start<br/>{streamARN, ContactId, ...}
    Cresta-->>Lambda: 200 OK {sessionId}
    
    Lambda-->>CF: Success Response
    deactivate Lambda

    Note over Lambda,KVS: Background: Stream Consumption

    Lambda->>KVS: GetMedia(streamARN, startFragmentNum)
    loop Continuous Stream
        KVS-->>Lambda: Audio Chunks
        Lambda->>Cresta: WebSocket Push
    end

    Note over CF,Cresta: Call Ends

    CF->>Lambda: Invoke /stream/stop
    Lambda->>Cresta: POST /stream/stop {sessionId}
                </div>
            </div>

            <h3>Lambda Function Requirements</h3>
            <table>
                <thead><tr><th>Requirement</th><th>Specification</th><th>Notes</th></tr></thead>
                <tbody>
                    <tr><td><strong>Runtime</strong></td><td>Node.js 18.x or Python 3.11</td><td>Per AWS Lambda support</td></tr>
                    <tr><td><strong>Memory</strong></td><td>512 MB minimum</td><td>Audio processing overhead</td></tr>
                    <tr><td><strong>Timeout</strong></td><td>30 seconds (initial) / 15 minutes (stream)</td><td>Different for trigger vs stream</td></tr>
                    <tr><td><strong>Concurrency</strong></td><td>Reserved: 10-50</td><td>Based on concurrent calls</td></tr>
                    <tr><td><strong>IAM Permissions</strong></td><td>kinesisvideo:GetDataEndpoint, GetMedia</td><td>Cross-account access</td></tr>
                    <tr><td><strong>VPC</strong></td><td>Optional</td><td>üü° Verify if VPC required</td></tr>
                    <tr><td><strong>Environment Variables</strong></td><td>CRESTA_ENDPOINT_URL, CRESTA_API_KEY</td><td>üü° Verify auth method</td></tr>
                </tbody>
            </table>

            <h3>IAM Policy Example (Customer Account)</h3>
            <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin: 16px 0; overflow-x: auto;">
                <pre style="margin: 0; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kinesisvideo:GetDataEndpoint",
        "kinesisvideo:GetMedia"
      ],
      "Resource": "arn:aws:kinesisvideo:*:*:stream/*/[0-9]*"
    }
  ]
}</pre>
            </div>
        </section>

        <section>
            <h2>Risk Assessment</h2>
            
            <div class="card-grid">
                <div class="card latency">
                    <h4>‚è±Ô∏è Latency Risks</h4>
                    <table>
                        <tr><td>KVS to Cresta Network</td><td><span class="badge medium">Medium</span></td><td>&lt;100ms target</td></tr>
                        <tr><td>Lambda Cold Start</td><td><span class="badge low">Low</span></td><td>&lt;1s (reserved concurrency)</td></tr>
                        <tr><td>Audio Chunk Delivery</td><td><span class="badge medium">Medium</span></td><td>20-100ms WebSocket</td></tr>
                        <tr><td>Cross-Region Latency</td><td><span class="badge medium">Medium</span></td><td>Deploy in same region</td></tr>
                    </table>
                    <p style="margin-top: 12px; font-size: 0.8125rem;"><strong>Mitigation:</strong> Regional deployment, connection pooling, reserved Lambda concurrency</p>
                </div>
                
                <div class="card security">
                    <h4>üîí Security Risks</h4>
                    <table>
                        <tr><td>Cross-Account KVS Access</td><td><span class="badge medium">Medium</span></td><td>IAM least privilege</td></tr>
                        <tr><td>Audio in Transit</td><td><span class="badge low">Low</span></td><td>TLS 1.2+ mandatory</td></tr>
                        <tr><td>API Authentication</td><td><span class="badge pending">üü° Verify</span></td><td>Confirm Cresta method</td></tr>
                        <tr><td>Lambda Environment Vars</td><td><span class="badge medium">Medium</span></td><td>Encrypt with KMS</td></tr>
                    </table>
                    <p style="margin-top: 12px; font-size: 0.8125rem;"><strong>Mitigation:</strong> IAM roles, KMS encryption, secrets management</p>
                </div>
                
                <div class="card compliance">
                    <h4>üìã Compliance Risks</h4>
                    <table>
                        <tr><td>Call Recording Consent</td><td><span class="badge medium">Medium</span></td><td>Two-party consent states</td></tr>
                        <tr><td>Data Residency</td><td><span class="badge low">Low</span></td><td>Regional Cresta deployment</td></tr>
                        <tr><td>PII in Transcripts</td><td><span class="badge low">Low</span></td><td>Cresta auto-redaction</td></tr>
                        <tr><td>Audit Trail</td><td><span class="badge low">Low</span></td><td>CloudWatch + Cresta logs</td></tr>
                    </table>
                    <p style="margin-top: 12px; font-size: 0.8125rem;"><strong>Mitigation:</strong> Contact Flow announcements, regional deployment, PII redaction enabled</p>
                </div>
                
                <div class="card operational">
                    <h4>‚öôÔ∏è Operational Risks</h4>
                    <table>
                        <tr><td>KVS Quota Limits</td><td><span class="badge low">Low</span></td><td>Monitor & request increases</td></tr>
                        <tr><td>Lambda Throttling</td><td><span class="badge low">Low</span></td><td>Reserved concurrency</td></tr>
                        <tr><td>Cresta Availability</td><td><span class="badge pending">üü° Verify</span></td><td>Failover behavior TBD</td></tr>
                        <tr><td>Stream Interruption</td><td><span class="badge low">Low</span></td><td>gowalter recovery mechanism</td></tr>
                    </table>
                    <p style="margin-top: 12px; font-size: 0.8125rem;"><strong>Mitigation:</strong> Monitoring, auto-scaling, recovery mechanisms</p>
                </div>
            </div>
        </section>

        <section>
            <h2>POC Integration Checklist</h2>
            
            <h3>Pre-POC Setup Tasks</h3>
            <table>
                <thead><tr><th>Task</th><th>Owner</th><th>Duration</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td>Create Contact Flow with media streaming</td><td>Customer</td><td>2 hours</td><td>‚Äî</td></tr>
                    <tr><td>Deploy Lambda function (Cresta-provided or custom)</td><td>Customer/Cresta</td><td>4 hours</td><td>üü° Verify provider</td></tr>
                    <tr><td>Configure IAM roles for KVS access</td><td>Customer</td><td>2 hours</td><td>‚Äî</td></tr>
                    <tr><td>Set up Cresta tenant and configure routing</td><td>Cresta</td><td>1 day</td><td>‚Äî</td></tr>
                    <tr><td>Install Cresta Agent App on pilot agent desktops</td><td>Customer</td><td>1 day</td><td>üü° Verify deployment</td></tr>
                    <tr><td>Configure monitoring (CloudWatch, Cresta dashboards)</td><td>Both</td><td>4 hours</td><td>‚Äî</td></tr>
                    <tr><td>Test call with audio streaming validation</td><td>Both</td><td>2 hours</td><td>‚Äî</td></tr>
                </tbody>
            </table>

            <h3>Integration Validation Tests</h3>
            <table>
                <thead><tr><th>Test</th><th>Expected Result</th><th>Pass Criteria</th></tr></thead>
                <tbody>
                    <tr><td>Audio streaming initiation</td><td>KVS stream starts within 1 second of call start</td><td>streamARN logged correctly</td></tr>
                    <tr><td>Lambda trigger execution</td><td>Lambda invoked successfully with all contact attributes</td><td>200 OK response</td></tr>
                    <tr><td>Dual-track audio separation</td><td>Customer and agent audio on separate tracks</td><td>Speaker diarization accurate</td></tr>
                    <tr><td>Cresta endpoint connectivity</td><td>Audio chunks delivered to gowalter</td><td>No connection errors</td></tr>
                    <tr><td>Real-time transcription</td><td>Transcripts appear in Agent App &lt;1.5s</td><td>Measured via timestamp</td></tr>
                    <tr><td>Agent App integration</td><td>Hints and suggestions display correctly</td><td>Agent feedback positive</td></tr>
                    <tr><td>Call termination cleanup</td><td>KVS stream stopped, resources released</td><td>No resource leaks</td></tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Items Requiring Follow-up üü°</h2>
            
            <div class="highlight-box danger">
                <h4>üî¥ High Priority (Integration Critical)</h4>
                <ol style="padding-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                    <li><strong>KVS Consumer Implementation:</strong> Does Cresta use Lambda consumer or direct GetMedia API? Is the Lambda function provided by Cresta or customer-built?</li>
                    <li><strong>Authentication Method:</strong> API Key, OAuth, or IAM-based auth to Cresta endpoints? What credentials are required in Lambda environment variables?</li>
                    <li><strong>Contact Attribute Mapping:</strong> What custom attributes are required for Cresta tenant routing? Confirm exact attribute names (CrestaCustomerId, etc.)</li>
                    <li><strong>Failover Behavior:</strong> Does call continue if Cresta stream fails? What happens to active calls during Cresta maintenance?</li>
                    <li><strong>Multi-Region Setup:</strong> How is traffic routed for multi-region Connect deployments? Any special DNS or load balancing requirements?</li>
                </ol>
            </div>

            <div class="highlight-box warning">
                <h4>üü° Medium Priority (Operational)</h4>
                <ol start="6" style="padding-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                    <li><strong>Lambda Code Ownership:</strong> Who maintains the Lambda function code? What is the support model for updates?</li>
                    <li><strong>Agent App Deployment:</strong> Is it browser extension, standalone desktop app, or embedded in CCP? What are installation requirements?</li>
                    <li><strong>VPC Requirements:</strong> Does Lambda need VPC configuration for Cresta connectivity? Any firewall rules required?</li>
                    <li><strong>Monitoring Integration:</strong> How do Cresta metrics integrate with CloudWatch? What dashboards are available?</li>
                    <li><strong>Cost Model:</strong> How is pricing calculated for KVS streaming? Any additional AWS charges beyond standard rates?</li>
                </ol>
            </div>
        </section>
    </div>

    <footer>
        <div class="container">
            <div>Cresta AI Platform Assessment - Document 02: Amazon Connect Integration</div>
            <div>January 2025 | Version 2.0</div>
        </div>
    </footer>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#f97316', primaryTextColor: '#f1f5f9', primaryBorderColor: '#334155',
                lineColor: '#64748b', secondaryColor: '#1e293b', tertiaryColor: '#0f172a',
                background: '#1e293b', mainBkg: '#1e293b', nodeBorder: '#334155',
                clusterBkg: '#1e293b', clusterBorder: '#475569'
            },
            flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },
            sequence: { useMaxWidth: true },
            securityLevel: 'loose'
        });
    </script>
</body>
</html>
